<!doctype html>
<html lang="us">
<head>
	<meta charset="utf-8">
	<title>First jQuery UI</title>
	<link href="css/smoothness/jquery-ui-1.10.3.custom.css" rel="stylesheet">
	<script src="js/jquery-1.9.1.js"></script>
	<script src="js/jquery.jqGrid.min.js"></script>
	<script src="js/jquery-ui-1.10.3.custom.js"></script>
	<script>
		$(function() {			
		    $( "#tabs" ).tabs();
    	});
	</script>

	<style type=text/css>
		li.ui-state-default {
    		font-size : 10px;
  		}
  		div.ui-tabs-panel {
    		font-size : 10px;
    		font-family : georgia;
    		font-style : italic;
  		}
  	</style>

	<script>
  
  		$(document).ready(function(){
			console.log('in ready ... ');
			
			var previousclass;
			var currentStudent;

			init();
			
			$("#btnaddstudent").click(function() {
				console.log("click add student ... ");
			});
			
			$("#btnStudentSearch").click(function() {
				console.log (" search student by name ... ");
				var fname = $.trim($("#searchStudentFirstName").val());
				var lname = $.trim($("#searchStudentLastName").val());
				$("#addStudent").empty();
				if ((null == fname || fname.length == 0) ||
				    (null == lname || lname.length == 0)) {
				    alert("please input both last name and first name");
				} else {
					console.log (" call ajax to get student ... ");
					$("#studentInformation").empty();
					getStudentByName(fname, lname);
				}
			});
			
			$("#btnStudentAdd").click(function() {
				console.log(" add new student ");
				$("#studentInformation").empty();
				$("#addStudent").empty();
				addNewStudent();
			});
			
			$("#tabs").on( "tabsactivate", function( event, ui ) {
				if (ui.newPanel.is("#tabs-CheckIn")) {
					initCheckinTab();
				}
			});
			
			$("#checkinClassCombobox").focus(function() {
				previousclass = this.value;
			}).change(function() {
				if (this.value != "" && "default" != this.value) {
					$("#btnStudentCheckInSearch").prop("disabled", false);
					$("#btnNonClassStudentCheckInSearch").prop("disabled",false);
					
					if (this.value != previousclass) {
						$("#tempdiv").empty();
						$("#nonclassstudentdiv").empty();
					}
				} else {
					$("#btnStudentCheckInSearch").prop("disabled", true);
					$("#btnNonClassStudentCheckInSearch").prop("disabled", true);
					
					$("#tempdiv").empty();
					$("#nonclassstudentdiv").empty();
				}
			});

			$("#btnStudentCheckInSearch").click(function() {
				console.log(" search student for check in process .. ");
				var checkinclasses = $("#checkinClassCombobox").val();
				if (null == checkinclasses || checkinclasses.length == 0) {
					alert("please select one class from the list");
				} else {
					getStudentCheckInDtoList(checkinclasses);
				}
			});
			
			$("#btnNonClassStudentCheckInSearch").click(function() {
				console.log(" search non class student for check in process .. ");
				var fname = $.trim($("#fname").val());
				var lname = $.trim($("#lname").val());
				if ((null == fname || fname.length == 0) ||
				    (null == lname || lname.length == 0)) {
				    alert("please input both last name and first name");
				} else {
					getNonClassStudentCheckInDto(lname, fname, $("#checkinClassCombobox").val());
				}
			});
			
			$(document).on('click', '#btnaddstudent', addNewStudentInSystem);
			
			$(document).on('click', '#btnedit', function() {
				console.log(" edit student button click ... ");
				if ("Edit" == $("#btnedit").val()) {
					$("#studentInformation :text").prop("disabled", false);
					$("#txtfname").focus();
					$("#btnedit").val("Cancel");
				} else if ("Cancel" == $("#btnedit").val()) {
					console.log (" cancel edit student information ... ");
					cancelUpdateStudentInformation();
					$("#studentInformation :text").prop("disabled", true);
					$("#btnedit").val("Edit");
				}
			});
			
			$(document).on('click', '#btnsave', function() {
				console.log(" save student button click ... ");
				$("#studentInformation :text").prop("disabled", true);
				updateStudentInformation();
			});
			
			$(document).on('click', '#tempdiv :button', function() {
				console.log(" click new button ... " + this.id);
				checkInStudent(this.id, $("#checkinClassCombobox").val());
			});

			$(document).on('click', '#nonclassstudentdiv :button', function() {
				console.log(" click new button ... " + this.id);
				checkInStudent(this.id, $("#checkinClassCombobox").val());
			});
		});
		
		function addNewStudentInSystem() {
				console.log("click add student ... ");
		};
		
		function addNewStudent() {
			$("#addStudent").append("<br />");

			$("#addStudent").append("<h2> Student information </h2>");
			
			$("#addStudent").append("<label>Student First Name : </label>");
			var fname = $('<input/>').attr({ type: 'text', id:"txtaddfname"});
			$("#addStudent").append(fname);
			
			$("#addStudent").append("<label> Last Name : </label>");
			var lname = $('<input/>').attr({ type: 'text', id:'txtaddlname'});
			$("#addStudent").append(lname);
			$("#addStudent").append("<br />");
			
			$("#addStudent").append("<label>        Email :</label>");
			var email = $('<input/>').attr({ type: 'text', id:'txtaddemail'});
			$("#addStudent").append(email);
			
			$("#addStudent").append("<br />");
			$("#addStudent").append("<br />");
			
			var savebutton = $('<input/>').attr({ type: 'button', id:"btnaddstudent", value:"Add"});
			$("#addStudent").append(savebutton);

		};
		
		function cancelUpdateStudentInformation() {
			$("#txtfname").val(currentStudent.firstName);
			$("#txtlname").val(currentStudent.lastName);
			$("#txtemail").val("Email@address.com");
		};
		
		function updateStudentInformation() {
			console.log(' update student information ... ');
			var fname = $("#txtfname").val();
			var lname = $("#txtlname").val();
			var student = { "id":currentStudent.id, "firstName":fname, "lastName":lname };	

			$.ajax({
				type: "POST",
				dataType: "json",
				url: "../msd-app/msdstudent",
				data: JSON.stringify(student),
				contentType: "application/json",
				processData:false,
				success: function(response) {
					if (500 == response.code) {
						alert("Internal Error, Please check service. ");
					} else if (201 == response.code) {
						console.log(" update student successfully ... ");
						currentStudent = $.parseJSON(response.result);
						$("#searchStudentFirstName").val(currentStudent.firstName);
						$("#searchStudentLastName").val(currentStudent.lastName);
					} else {
						alert('error');
					}
				},
				error: function(msg, url, line) {
					alert('error');
				}
			});
		};
		
		function getStudentByName(fname, lname) {
			console.log(' get student by name ... ');
			
			$.ajax({
				type: "GET",
				dataType: "json",
				url: "../msd-app/msdstudent",
				data: { firstname: fname, lastname: lname },
				success: function(response) {
					console.log(" get student ... ");
					if (404 == response.code) {
						alert(" Can't found student, Please check your input ... ");
						$("#searchStudentFirstName").focus();
					} else if (302 == response.code) {
						currentStudent = $.parseJSON(response.result);
						var data = $.parseJSON(response.result);
						showStudentInformation(data);
					} else {
						alert("error to find student ... ");
					}
				},
				error: function(msg, url, line) {
					alert('error to get student ... ');
				}
			});
		};

		function showStudentInformation(data) {
			$("#studentInformation").append("<br />");

			$("#studentInformation").append("<h2> Student information </h2>");
			
			$("#studentInformation").append("<label>Student First Name : </label>");
			var fname = $('<input/>').attr({ type: 'text', id:"txtfname", value:data.firstName});
			fname.prop("disabled",true);
			$("#studentInformation").append(fname);
			
			$("#studentInformation").append("<label> Last Name : </label>");
			var lname = $('<input/>').attr({ type: 'text', id:'txtlname', value:data.lastName});
			lname.prop("disabled",true);
			$("#studentInformation").append(lname);
			$("#studentInformation").append("<br />");
			
			$("#studentInformation").append("<label>        Email :</label>");
			var email = $('<input/>').attr({ type: 'text', id:'txtemail', value:'Email@address.com'});
			email.prop("disabled",true);
			$("#studentInformation").append(email);
			
			$("#studentInformation").append("<br />");
			$("#studentInformation").append("<br />");
			$("#studentInformation").append("<br />");
			
			var editbutton = $('<input/>').attr({ type: 'button', id:"btnedit", value:"Edit"});
			$("#studentInformation").append(editbutton);

			var savebutton = $('<input/>').attr({ type: 'button', id:"btnsave", value:"Save"});
			$("#studentInformation").append(savebutton);

			$("#studentInformation").append("<br />");

			$("#studentInformation").append("<h2> Student register class information </h2>");
			
			$("#studentInformation").append("<table id=divgrid></table>");

			getStudentRegisterClass(data);
		};
		
		function getStudentRegisterClass(data) {
			console.log(' get student register class ... ');
			
			$.ajax({
				type: "GET",
				dataType: "json",
				url: "../msd-app/msdstudent",
				data: { type: "registerclass", msdstudentid: data.id },
				success: function(response) {
					console.log(" get student register class ... ");
					if (404 == response.code) {
						alert(" Can't found student, Please check your input ... ");
						$("#searchStudentFirstName").focus();
					} else if (302 == response.code) {
						var data = $.parseJSON(response.result);
						var rowCount = data.length;
			            var table = $('<table> <caption>Monthly savings</caption> </table>');
            			for(i=0; i<rowCount; i++){
			                var row = $('<tr></tr>');
		                    var column1 = $('<td></td>').text(data[i].id);
		                    var column2 = $('<td></td>').text(data[i].name);
		                    table.append(row);
        		            row.append(column1);
        		            row.append(column2);
		                }
			            $('#studentInformation').append(table);
					} else {
						alert("error to find student ... ");
					}
				},
				error: function(msg, url, line) {
					alert('error to get student ... ');
				}
			});
		};
				
		function getNonClassStudentCheckInDto(lname, fname, cid) {
			console.log(' get non class checkin  student ... ');
			
			$.ajax({
				type: "GET",
				dataType: "json",
				url: "../msd-app/msdstudentcheckin",
				data: { msdclassid:cid, firstname: fname, lastname: lname, type: 'checkin' },
				success: function(response) {
					console.log(" get non class student for check in ");
					if (404 == response.code) {
						alert(" Can't found student, Please check your input ... ");
						$("#fname").focus();

					} else if (302 == response.code) {
						var data = $.parseJSON(response.result);
						$("#fname").val("");
						$("#lname").val("");
					
						var btnid="btnnew_" + data.studentId;
						var newbutton = document.getElementById(btnid);

						if (null == newbutton) {
							newbutton = $('<input/>').attr({ type: 'button', id:btnid, value:data.name});
							$("#nonclassstudentdiv").append(newbutton);
						} 
						if (data.checkedIn) {
							alert("you already checked in");
							$("#" + btnid).prop("disabled",true);
						} else {
							$("#" + btnid).focus();
						}
					} else {
						alert ('error to get non class student for check in ...');
					}
				},
				error: function(msg, url, line) {
					alert('error to get non class student for check in ... ');
				}
			});
		};
		
		function checkInStudent(btnid, cid) {
			var sid = btnid.substring(7);
			var checkintime = new Date();

			var scheckin = { "checkInTime":checkintime, "classId":cid, "id":0, "studentId":sid };
			
			$.ajax({
				type: "POST",
				url: "../msd-app/msdstudentcheckin",
				dataType: "json",
				data: JSON.stringify(scheckin),
				contentType: "application/json",
				processData:false,
				success: function(response) {
					if (500 == response.code) {
						alert("Internal Error, Please check service. ");
					} else if (201 == response.code) {
						$("#" + btnid).prop("disabled",true);
					} else {
						alert('error');
					}
				},
				error: function(msg, url, line) {
					alert('error');
				}
			});
		};

		function getStudentCheckInDtoList(classid) {
			console.log("in getStudentCheckInDtoList ... ");
						
			$.ajax({
				type: "GET",
				dataType: "json",
				url: "../msd-app/msdstudentcheckin",
				data: { msdclassid: classid, type: 'checkin' },
				success: function(response) {
					if (404 == response.code) {
						alert(" Can't get student list for check in class : " + classid);
					} else if (302 == response.code) {
						var data = $.parseJSON(response.result);
						$("#tempdiv").empty();

						$.each(data, function (i, theItem) {
							var newbutton = $('<input/>').attr({ type: 'button', id:'btnnew_' + theItem.studentId, value:theItem.name});
							if (theItem.checkedIn) {
								newbutton.prop("disabled", true);
							}
							$("#tempdiv").append(newbutton);
						});
					} else {
						alert('error');
					}
				},
				error: function(msg, url, line) {
					alert('error');
				}
			});
		};

		function getCheckInClassList() {
			console.log('in getCheckInClassList ... ');
			$.ajax({
				type: "GET",
				url: "../msd-app/msdclass",
				dataType: "json",
				contentType: "application/json",
				success: function(response) {
					if (404 == response.code) {
						alert(" Can't get class for check in process ... ");
					} else if (302 == response.code) {
						var data = $.parseJSON(response.result);

						$('#checkinClassCombobox option[value!="default"]').remove();

						$.each(data, function (i, theItem) {
							$("#checkinClassCombobox").append($("<option></option>").attr("value",theItem.id).text(theItem.name));
						});
					} else {
						alert('error');
					}
				},
				error: function(msg, url, line) {
					alert('error');
				}
			});
		};
		
		function initCheckinTab() {
			getCheckInClassList();
			$("#btnStudentCheckInSearch").prop("disabled", true);
			$("#btnNonClassStudentCheckInSearch").prop("disabled", true);
			$("#fname").val("");
			$("#lname").val("");
			$("#nonclassstudentdiv").empty();
			$("#tempdiv").empty();
		};
		
		function init() {
		};
  	</script>
</head>
<body>

	<p align="center"><img align="middle" src="msd.jpg" alt="some_text"></p>

	<div id="tabs">
	<ul>
    	<li><a href="#tabs-Student">Student</a></li>
	    <li><a href="#tabs-Class">Class</a></li>
	    <li><a href="#tabs-CheckIn">Student CheckIn</a></li>
	</ul>
  	<div id="tabs-Student">
    	<h2>MSD Student function ... </h2>
		<div class="ui-widget">
			<div id="searchStudent">
				<label>Please input student First Name and Last Name to Search</label>
				<br />
	  			<label>first name : </label>
  				<input type="text" id="searchStudentFirstName" />
  				<label>last name : </label>
  				<input type="text" id="searchStudentLastName" />
	  			<input id="btnStudentSearch" type="button" value="search" />
	  			<Label> or to add new student </label>
	  			<input id="btnStudentAdd" type="button" value="add" />
			</div>
			<div id="studentInformation"></div>
			<div id="addStudent"></div>
		</div>  
	</div>
  	<div id="tabs-Class">
    	<h2>MSD Class function ... </h2>
		<div class="ui-widget">
			<h3> Under construct ... </h3>
		</div>  
  	</div>
  	<div id="tabs-CheckIn">
    	<h2>Student Class Check In</h2>
    	<div class="ui-widget">
  			
  			<label>Please select class:</label>
  			<select id="checkinClassCombobox">
    			<option value="default">Select one...</option>
  			</select>
  			<input id="btnStudentCheckInSearch" type="button" value="search" />
  			<div id="addStudentCheckinButton_here">
  				<div id="tempdiv"></div>
  			</div>
  			
  			<label>If student not register to above class, or this is a makeup class please input student name to check in.</label>
  			<br/>
  			<label>first name : </label>
  			<input type="text" id="fname" />
  			<label>last name : </label>
  			<input type="text" id="lname" />
  			<input id="btnNonClassStudentCheckInSearch" type="button" value="search" />
  			<div id="addNonClassStudentCheckinButton_here">
  				<div id="nonclassstudentdiv"></div>
  			</div>
  		</div>
  	</div>
	</div>

</body>
</html>
